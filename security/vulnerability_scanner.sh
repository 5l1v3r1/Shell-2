#!/bin/bash
_zenity="/usr/bin/zenity"
_out="/tmp/scanner.output.$$"

function show_help {
  echo """
    Usage:
          `basename $0` -h                    | Show this help
          `basename $0` -d [directory]        | Set scripts location for selection
          `basename $0` -s [path/to/script]   | Set script
    """; exit 0
}

function list {
  _counter="1"

  echo "Select Script:"
  for entry in "$_scripts"*
  do
    echo "  $_counter) $entry"
    counter+=1
  done

  printf "\n[#?:] "; read _script

  echo "$_script"
}

function scan {
  _target=$(zenity --entry --title "Set target" --text "Enter target")
  _range=$(zenity --entry --title "Set range" --text "Enter range")

  nmap -sV --script $_script $_target $_range --system-dns --open -vv | tee >(${_zenity} --width=200 --height=100 \
  --title="nmap" --progress \
  --pulsate --text="Scanning target..." \
  --auto-kill --auto-close \
  --percentage=10) >${_out}

  ${_zenity} --width=800 --height=600 \
  --title "nmap scan result for $_target" \
  --text-info --filename="${_out}"
}

function banner {
  echo -e """
  \e[1;93m
                 _   _        __      ___
       /\       | | (_)       \ \    / (_)
      /  \   ___| |_ ___   ____\ \  / / _  _____      __
     / /\ \ / __| __| \ \ / / _ \ \/ / | |/ _ \ \ /\ / /
    / ____ \ (__| |_| |\ V /  __/\  /  | |  __/\ V  V /
   /_/____\_\___|\__|_| \_/ \___| \/   |_|\___| \_/\_/\e[0m
  \e[1;94m  / ____|                    (_) |
   | (___   ___  ___ _   _ _ __ _| |_ _   _
    \___ \ / _ \/ __| | | | '__| | __| | | |
    ____) |  __/ (__| |_| | |  | | |_| |_| |
   |_____/ \___|\___|\__,_|_|  |_|\__|\__, |
                                       __/ |
                                      |___/
  \e[0m
  \e[1;90m-------------------------------------------------------\e[0m
  """
}

# Options for args
if ! [ $1 ]; then
  show_help

elif [ "$1" == "-h" ]; then
  show_help

elif [ $1 == "-d" ]; then
  if ! [ $2 ]; then
    echo "[ERROR] Please, set a directory"
  else
    _scripts="$2"
    list
    exit 0
  fi

elif [ $1 == "-s" ]; then
  if [ $(echo $2 | cut -d '.' -f2) == "nse" ]; then

    _script="$2"
    echo -e "\e[1;32m[LOADED]\e[0m $_script"
    banner; scan
  else
    echo "[ERROR] Not a NSE script"
  fi
else
  echo "[ERROR] Invalid option"; exit 0
fi
